<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8" />
    <title>William Lachance's Log (page 12)</title>
    <meta name="description" content="William Lachance's Log (page 12)" />
    <meta name="author" content="William Lachance" />
    <meta name="keywords" content="Orangutan, Meditation, Iodide, Web, GoFaster, Release Engineering, zen, Python, Glean, Time, Metrics Graphics, iphone, Buddhism, Video, Transit to Go, Responsiveness, Data, Profiling, Docker, Social Media, GNOME, Psychology, Personal, Food, Montreal, Taskcluster, Talos, Telemetry, Treeherder, Mozilla, telemetry, Open Data, ateam, Data Visualization, mozregression, all, MSF, Pandaboard, Polling, Philosophy, Recurse, Usability, Meta, Irydium, Counting, email, Infraherder, Statistics, Free Software, Bikes, Mission Control, Nixi, Music, Business, Transit, BIXI, iodide, AI, Life, Île Sans Fil, Eideticker, Android, Voltus, Performance, FirefoxOS, hbus, Documentation, Environment, meta, Toronto, Ebola, Cats, Perfherder, Coffee, WifiDog, Sphinx, SQL, Community" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.ico" />
    <link rel="canonical" href="https://wrla.ch/index-12.html" />

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/style.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="/css/pygments.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="/css/scribble.css"
    />
    <!-- Feeds -->
    <link
      rel="alternate"
      type="application/atom+xml"
      href="/feeds/all.atom.xml"
      title="Atom Feed"
    />
    <link
      rel="alternate"
      type="application/rss+xml"
      href="/feeds/all.rss.xml"
      title="RSS Feed"
    />
    <!-- JS -->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-xxxxx', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
  <body>
    <nav
      class="flex items-center justify-between flex-wrap bg-gray-800 py-1 px-8"
    >
      <div class="flex items-center flex-shrink-0 text-gray-400 mr-6">
        <div class="p-1">
          <a href="/index.html"
            ><img
              src="/img/wlach_icon.png"
              width="32"
              height="32"
              class="p rounded"
          /></a>
        </div>
        <div class="p-1">
          <a
            href="/index.html"
            class="text-gray-200 font-semibold text-xl tracking-tight hover:text-white"
            >wlach log</a
          >
        </div>
      </div>
      <div class="flex-grow lg:flex lg:items-center">
        <div class="text-sm lg:flex-grow">
          <a
            href="/About.html"
            class="mt-4 lg:inline-block lg:mt-0 hover:text-white mr-4 text-gray-600"
          >
            About</a>
          <a
            class="mt-4 lg:inline-block lg:mt-0 text-gray-600 hover:text-white mr-4"
            href="/feeds/all.atom.xml"
            >Atom</a
          >
          <a
            class="mt-4 lg:inline-block lg:mt-0 text-gray-600 hover:text-white mr-4"
            href="/feeds/all.rss.xml"
            >RSS</a
          >
        </div>
      </div>
    </nav>
    <div id="content" class="container max-w-screen-md px-8 py-4 mx-auto">
         <article>
  <header>
    <h2><a href="/blog/2012/10/using-the-dm-utility-to-interact-with-android-or-firefoxos-devices/">Using the dm utility to interact with Android or FirefoxOS devices</a></h2>
    <p class="index-date">Oct 18th, 2012</p>
    <p><span class="tags"><a href="/tags/Android.html">Android</a>  <a href="/tags/Mozilla.html">Mozilla</a></span></p>
  </header>

<p>I promised a few people I&rsquo;d blog about this, so here you go.</p>

<p>To help with the business of making Android or FirefoxOS devices do our bidding, <a href="https://wiki.mozilla.org/Auto-tools">Mozilla Automation &#38; Tools</a> developed a Python library called <a href="https://github.com/mozilla/mozbase/tree/master/mozdevice">mozdevice</a> which allows you to control these devices either using the Android Debug Bridge protocol (which is actually not Android specific: FirefoxOS devices use it too) or the <a href="https://wiki.mozilla.org/Auto-tools/Projects/SUTAgent">System Under Test protocol</a> (a Mozilla-specific thing).</p>

<p>Anyone familiar with debugging these devices is doubtless familiar with adb, which provides a command line interface that allows you to push/pull files, run a shell, etc. To help test our python code (as well as expand the scope of what&rsquo;s possible on the command line), I created a similar utility a few months ago called &ldquo;dm&rdquo; which provides a command-line interface to the aforementioned mozdevice code. It&rsquo;s shipped as part of mozdevice, and testing it out is pretty simple if you have virtualenv installed:</p>

<pre><code>virtualenv mozdevice
cd mozdevice
./bin/pip install mozdevice
source bin/activate
dm --help</code></pre>

<p>I generally use this utility for two things:</p>

<ol>
 <li>Testing out mozdevice code. For example, today we discovered an (unfortunate) <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=803177">bug</a> in devicemanagerADB&rsquo;s killProcess routine. It was easy to verify both the problem and my fix did what I expected by starting my custom build of fennec and running this command:</li></ol>

<p> <code></code></p>

<p>dm &mdash;package-name org.mozilla.fennec_wlach killapp org.mozilla.fennec_wlach</p>

<p><code>(yes, it's a bit unfortunate that this bug occurred in the first place: devicemanagerADB really needs unit tests)

  2. Day-to-day menial tasks, like getting device info/status, capturing screenshots, etc. You can get a full list of what this utility is capable of by running :help. E.g.:

    ```
(mozbase)wlach@eideticker:~/src/eideticker$ dm --help
Usage: dm [options] &amp;lt;command&gt; [&amp;lt;args&gt;]

device commands:
  info [os|id|uptime|systime|screen|memory|processes] - get
      information on a specified aspect of the device (if no argument
      given, print all available information)
  install &amp;lt;file&gt; - push this package file to the device and install it
  killapp &amp;lt;process name&gt; - kills any processes with a particular name
      on device
  launchapp &amp;lt;appname&gt; &amp;lt;activity name&gt; &amp;lt;intent&gt; &amp;lt;URL&gt; - launches
      application on device
  ls &amp;lt;remote&gt; - list files on device
  ps  - get information on running processes on device
  pull &amp;lt;local&gt; [remote] - copy file/dir from device
  push &amp;lt;local&gt; &amp;lt;remote&gt; - copy file/dir to device
  rm &amp;lt;remote&gt; - remove file from device
  rmdir &amp;lt;remote&gt; - recursively remove directory from device
  screencap &amp;lt;png file&gt; - capture screenshot of device in action
  shell &amp;lt;command&gt; - run shell command on device

Options:
  -h, --help            show this help message and exit
  -v, --verbose         Verbose output from DeviceManager
  --host=HOST           Device hostname (only if using TCP/IP)
  -p PORT, --port=PORT  Custom device port (if using SUTAgent or adb-over-tcp)
  -m DMTYPE, --dmtype=DMTYPE
                        DeviceManager type (adb or sut, defaults to adb)
  -d HWID, --hwid=HWID  HWID
  --package-name=PACKAGENAME
                        Packagename (if using DeviceManagerADB)</code></p>

<pre><code>Before you ask, yes, it's technically possible to do much of this with the original adb utility. But (1) some of our internal stuff can't use adb a variety of reasons and (2) some of the tasks above (e.g. launching an app, getting a screenshot) involve considerably more typing with adb than with dm. So it's still a win. &lt;/li&gt; &lt;/ol&gt;

Happy command-lining!</code></pre> 
  <hr/>
</article>
<article>
  <header>
    <h2><a href="/blog/2012/10/catching-problems-early-with-python/">Catching problems early with python</a></h2>
    <p class="index-date">Oct 15th, 2012</p>
    <p><span class="tags"><a href="/tags/Mozilla.html">Mozilla</a>  <a href="/tags/Python.html">Python</a></span></p>
  </header>

<p>Just a few quick notes on how to avoid a class of errors I&rsquo;ve been seeing in Mozilla&rsquo;s automation over the last year. Since python interprets code dynamically, it&rsquo;s pretty easy for problems like undefined variables to slip through, especially if they&rsquo;re in a codepath that isn&rsquo;t frequently tested. The most recent example I found was in some cleanup-after-error code for remote mochitest/reftest, which tried to call &ldquo;self.cleanup&rdquo; from a standalone method.</p>

<pre><code>def main():
      ...
      try:
        dm.recordLogcat()
        retVal = mochitest.runTests(options)
        logcat = dm.getLogcat()
      except:
        print "TEST-UNEXPECTED-FAIL | %s | Exception caught while running tests." % sys.exc_info()[1]
        mochitest.stopWebServer(options)
        mochitest.stopWebSocketServer(options)
        try:
            self.cleanup(None, options)
        except:
            pass
</code></pre>

<p><a href="http://hg.mozilla.org/mozilla-central/file/942ed5747b63/testing/mochitest/runtestsremote.py#l481">testing/mochitest/runtestsremote.py</a></p>

<p>We&rsquo;re calling cleanup as if it were a class variable, but we&rsquo;re not inside any class! It&rsquo;s easy to see what will happen if you try to run some similar code from the python console:</p>

<pre><code>&gt;&gt;&gt; self.cleanup()
Traceback (most recent call last):
  File "&amp;lt;stdin&gt;", line 1, in &amp;lt;module&gt;
NameError: name 'self' is not defined</code></pre>

<p>However, because we&rsquo;re in a blanket try&hellip;except, we will never see an error. The cleanup code will never be called, instead the exception is immediately caught and subsequently ignored. Probably not the end of the world in this case (there are other parts of our mobile automation which will perform the same cleanup later), but it&rsquo;s easy to imagine where this would be a more serious problem.</p>

<p>There&rsquo;s two very easy ways to help stop errors like this before they hit our code:</p>

<ol>
 <li>Try to avoid using a blanket try&hellip;except. In addition to catching legitimate problems which we want to ignore (in the remote case for example, devicemanager exceptions), it also catches (and thus obscures) things like syntax, name, or type errors. Instead, try just catching the specific exception you&rsquo;re looking for. For example, we might rewrite the case above as:</li></ol>

<p> <code></code></p>

<p>try: mochitest.cleanup(None, options) except devicemanager.DMError: print &ldquo;WARNING: Device error while cleaning up&rdquo;</p>

<p><code>2. pyflakes, pyflakes, pyflakes. [Pyflakes][2] is a fantastic tool for analyzing your python code for common problems. It's kind of analagous to [jslint][3], for those of you familiar with that. Here's what happens when we run pyflakes against the offending code:

    ```
wlach@eideticker:~/src/mozilla-central$ pyflakes testing/mochitest/runtestsremote.py
testing/mochitest/runtestsremote.py:7: 'time' imported but unused
testing/mochitest/runtestsremote.py:481: undefined name 'self'
testing/mochitest/runtestsremote.py:500: undefined name 'self'</code></p>

<pre><code>I've found pyflakes to be an indispensable part of my workflow. I generally run it after making any substantial change to a python file, and certainly before pushing anything to be consumed by others.</code></pre>

<p>Ultimately there&rsquo;s no substitute for actually thoroughly testing your code, no matter what language you&rsquo;re using. But using the right techniques and tools can certainly make your life easier.</p>

<p>[ for those wondering, a fix for the issue mentioned in this post is part of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=801652">bug 801652</a> ]</p> 
  <hr/>
</article>
<article>
  <header>
    <h2><a href="/blog/2012/09/say-hello-to-frof/">Say hello to frof</a></h2>
    <p class="index-date">Sep 25th, 2012</p>
    <p><span class="tags"><a href="/tags/Android.html">Android</a>  <a href="/tags/Mozilla.html">Mozilla</a>  <a href="/tags/Profiling.html">Profiling</a></span></p>
  </header>

<p>Inspired by the work I&rsquo;d been doing with Benoit Girard to <a href="http://wrla.ch/blog/2012/09/more-eideticker-happenings-profiling-and-startup-testing/">integrate the Firefox Profiler with Eideticker</a>, I decided to create an easy-to-use python script to help with gathering profiles on Fennec, which I call <a href="https://github.com/wlach/frof">frof</a>.</p>

<p>Frof pretty considerably reduces the amount of busywork you need to do to gather a profile. Instead of a rather complicated multi-step process to initialize fennec with the right parameters for profiling, downloading profiles, etc., you can just run the frof script like so:
 <br /><code>&lt;br /&gt; frof org.mozilla.fennec http://wrla.ch mywonderfulprofile.zip&lt;br /&gt;</code>
 <br />Assuming that frof was bootstrapped correctly (and your phone is connected to your computer in debugging mode), this should start up fennec automatically with that URL loaded. Now, just perform whatever action you want to profile on your phone, then press enter in the terminal when you&rsquo;re done. Voila, instant profile trace which you can examine, post to bugs, etc. All the other details are automated.</p>

<p>Backstory: the inspiration for frof came from a personal itch of mine, the fact that leaflet.js maps seem to be causing out-of-memory errors on Fennec when zooming is enabled (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=784580">bug 784580</a>). I wanted to be able to capture some profiles to see what was going on, but the <a href="https://developer.mozilla.org/en-US/docs/Performance/Profiling_with_the_Built-in_Profiler#Profiling_Firefox_mobile">current instructions</a> on MDN seem a bit unwieldly. I figured I&rsquo;d get lots of mileage out of a tool to make this easier (especially if I was going to get into a profile, edit, debug cycle), so I spent a few hours dilligently copying the logic we put into eideticker to gather profiles into a standalone script.</p>

<p><a href="http://wrla.ch/blog/2012/09/say-hello-to-frof/frof-profile-leaflet/" rel="attachment wp-att-760"><img src="/files/2012/09/frof-profile-leaflet.png" alt="A profile I generated of a leaflet map with frof" title="frof profile leaflet" width="703" height="365" class="alignnone size-full wp-image-760" srcset="/files/2012/09/frof-profile-leaflet-300x155.png 300w, /files/2012/09/frof-profile-leaflet.png 703w" sizes="(max-width: 703px) 100vw, 703px" /></a></p>

<p>Unfortunately in my case, the gecko profile didn&rsquo;t tell me much, aside from the fact that Gecko didn&rsquo;t seem to be the culprit (remember that on Android we also have lots of Java-based frontend code to contend with, which the profiler doesn&rsquo;t measure). I&rsquo;m going to stare more at the Java code and dig into the various high-level tools that Android provides for profiling performance and memory usage. My current hypothesis is that the problem is the screenshot code and the CSS transitions that leaflet generates when zooming. In the mean time, the only thing I have to show for my foray away from writing tools for Mozilla is yet another tool.</p>

<p>Oh well, it could be worse. My fervent hope is that frof will be helpful for both Fennec developers and QA. Let me know if you wind up using it!</p> 
  <hr/>
</article>
<article>
  <header>
    <h2><a href="/blog/2012/09/more-eideticker-happenings-profiling-and-startup-testing/">More Eideticker happenings: Profiling and startup testing</a></h2>
    <p class="index-date">Sep 13th, 2012</p>
    <p><span class="tags"><a href="/tags/Eideticker.html">Eideticker</a>  <a href="/tags/Mozilla.html">Mozilla</a></span></p>
  </header>

<p><em>[ For more information on the Eideticker software I&rsquo;m referring to, see <a href="http://wrla.ch/blog/2012/06/mobile-firefox-measuring-how-a-browser-feels/">this entry</a> ]</em></p>

<p>Just wanted to give some updates on a few new Eideticker features which have landed in the past week.</p>

<p><strong>Profiling support</strong></p>

<p>While Eideticker is a great tool for observing the external behaviour of the mobile browser, it hasn&rsquo;t been able to tell us much about what&rsquo;s going on inside. If something&rsquo;s slow, why is it slow? If it&rsquo;s slower than it was the day before, what&rsquo;s the cause? If it&rsquo;s faster? What explains the deviations in test results from one run to the other?</p>

<p>Thanks to <a href="http://benoitgirard.wordpress.com/">Benoit Girard</a> (+ a little bit of integration work from me), we can now start providing answers to these questions. Eideticker now has a mode that allows us to capture a <a href="https://developer.mozilla.org/en-US/docs/Performance/Profiling_with_the_Built-in_Profiler">sampling profile</a> of the application while the video capture is ongoing. From the dashboard, you can now get access said profile, just by clicking on a link.</p>

<p><a href="http://wrla.ch/blog/2012/09/more-eideticker-happenings-profiling-and-startup-testing/dash-with-link-to-profile/" rel="attachment wp-att-737"><img src="/files/2012/09/dash-with-link-to-profile.png" alt="" title="Eideticker dashboard with link to profile" width="764" height="555" class="alignnone size-full wp-image-737" srcset="/files/2012/09/dash-with-link-to-profile-300x217.png 300w, /files/2012/09/dash-with-link-to-profile.png 764w" sizes="(max-width: 764px) 100vw, 764px" /></a>
 <br /><a href="http://wrla.ch/blog/2012/09/more-eideticker-happenings-profiling-and-startup-testing/profiler-et-screenshot/" rel="attachment wp-att-740"><img src="/files/2012/09/profiler-et-screenshot.png" alt="" title="Profile of Eideticker Capture" width="852" height="425" class="alignnone size-full wp-image-740" srcset="/files/2012/09/profiler-et-screenshot-300x149.png 300w, /files/2012/09/profiler-et-screenshot.png 852w" sizes="(max-width: 852px) 100vw, 852px" /></a></p>

<p>Note that the profile is not yet synchronized precisely to the videocapture (the profile works over the entire run of the browser), but Benoit is busily making that happen. That should hopefully land soon, in the mean time we still have some pretty useful data.</p>

<p>To say I&rsquo;m excited about this would be an understatement. I think it has the potential to open up a whole new world of understanding of why our mobile (and desktop, someday) browser performs the way it does.</p>

<p><strong>Startup / pageload testing</strong></p>

<p>Eideticker has had support for measuring startup and page load time for a few months now, but I hadn&rsquo;t yet hooked it up to the dashboard. As of today, it now is. There&rsquo;s a bunch of different angles that are interesting to measure here (new vs. old profiles, whether the browser has been launched since boot, launching web applications, loading about:home or loading a web page, &hellip;) which I&rsquo;ll get to in due course. For now, we at least have a baseline of how long it takes to see the Firefox homescreen on a Galaxy Nexus:</p>

<video width="400px" src="http://wrla.ch/eideticker/dashboard/videos/video-1347572002.11.webm" controls="controls"></video>

<p>Of course, this is hooked up to the profiling support previously mentioned. Here&rsquo;s <a href="http://people.mozilla.com/~bgirard/cleopatra/?zippedProfile=profiles/sps-profile-1347572285.4.zip&amp;videoCapture=videos/video-1347572285.4.webm">an example profile</a>.</p>

<p>I&rsquo;ve already filed <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=791106">one bug</a> based on the data gathered so far.</p> 
  <hr/>
</article>
<article>
  <header>
    <h2><a href="/blog/2012/09/oh-hai-i-upergaded-yer-eideticker/">Oh hai, I upergaded yer Eideticker</a></h2>
    <p class="index-date">Sep 5th, 2012</p>
    <p><span class="tags"><a href="/tags/Eideticker.html">Eideticker</a>  <a href="/tags/Mozilla.html">Mozilla</a></span></p>
  </header>

<p><em>[ For more information on the Eideticker software I&rsquo;m referring to, see <a href="http://wrla.ch/blog/2012/06/mobile-firefox-measuring-how-a-browser-feels/">this entry</a> ]</em></p>

<p><a href="http://wrla.ch/blog/2012/09/oh-hai-i-upergaded-yer-eideticker/multi-device-dash/" rel="attachment wp-att-709"><img src="/files/2012/09/multi-device-dash.png" alt="" title="multi-device-dash" width="771" height="576" class="alignnone size-full wp-image-709" srcset="/files/2012/09/multi-device-dash-300x224.png 300w, /files/2012/09/multi-device-dash.png 771w" sizes="(max-width: 771px) 100vw, 771px" /></a></p>

<p>More on this to come, but just a quick note that the client-side URL schema for the Eideticker dashboard has been changed, as we now gather benchmarks for more than one device (Samsung Galaxy Nexus benchmarks FTW). To get the new and improved dashboard, please just go to the root:</p>

<p><a href="http://wrla.ch/eideticker/dashboard">http://wrla.ch/eideticker/dashboard</a></p>

<p>Old style URLs like <code>http://wrla.ch/eideticker/dashboard/#/taskjs-scrolling/checkerboard</code> will no longer work. Sorry for any broken links, this is the price of progress. 😉</p>

<p>Note that some benchmarks for the Galaxy Nexus are still missing. This is a known problem and will be fixed soon.</p> 
  <hr/>
</article>
<article>
  <header>
    <h2><a href="/blog/2012/07/the-evolution-of-simulating-events-in-eideticker-from-monkeys-to-orangutans/">The evolution of simulating events in Eideticker: from monkeys to orangutans</a></h2>
    <p class="index-date">Jul 10th, 2012</p>
    <p><span class="tags"><a href="/tags/Eideticker.html">Eideticker</a>  <a href="/tags/Mozilla.html">Mozilla</a>  <a href="/tags/Orangutan.html">Orangutan</a></span></p>
  </header>

<p><em>[ For more information on the Eideticker software I&rsquo;m referring to, see <a href="http://wrla.ch/blog/2012/06/mobile-firefox-measuring-how-a-browser-feels/">this entry</a> ]</em></p>

<p>I just merged a new approach I&rsquo;ve been using to simulate touch events into the master branch of Eideticker called <a href="http://github.com/wlach/orangutan">Orangutan</a>.</p>

<p><a href="http://wrla.ch/blog/2012/07/the-evolution-of-simulating-events-in-eideticker-from-monkeys-to-orangutns/orangutan/" rel="attachment wp-att-696"><img src="/files/2012/07/orangutan.jpg" alt="Image of Orangutan" title="orangutan" width="415" height="600" class="alignnone size-full wp-image-696" srcset="/files/2012/07/orangutan-207x300.jpg 207w, /files/2012/07/orangutan.jpg 415w" sizes="(max-width: 415px) 100vw, 415px" /></a></p>

<p>As I&rsquo;ve mentioned before, we really need to simulate actual user gestures when doing this type of testing to measure real-world performance with Eideticker. Up to now, I&rsquo;ve been using google&rsquo;s <a href="http://developer.android.com/tools/help/monkeyrunner_concepts.html">MonkeyRunner</a> tool to do this. I was always a little skeptical about its approach (which involved using a privileged tool written in Java with special access to Android&rsquo;s windowing system), but up until recently I&rsquo;d managed to get around its <a href="http://code.google.com/p/android/issues/detail?id=27955">issues</a> with a <a href="https://github.com/mozilla/eideticker/commit/8d034212bc38c1fc80b9fe792c0b06919c74141a">successively</a> <a href="https://github.com/mozilla/eideticker/commit/55d63960dc0a5090cee00fe917a851db082ee0fd">more</a> <a href="https://github.com/mozilla/eideticker/commit/686882d32fb25a700afec35c39e53a73658688e3">complicated</a> series of hacks.</p>

<p>Unfortunately, I finally came up with a problem that I couldn&rsquo;t figure out how to fix: monkeyrunner doesn&rsquo;t attach precise timing information to the events it generates, which completely throws off Google Chrome for Android when you try to simulate a pan gesture. I&rsquo;ve tried just about every way of using the existing functionality (both the networked mode and the &ldquo;script&rdquo; mode), but nothing seemed to help. My conclusion is that the only way of continuing to use monkey would be to create a fix for the software itself, which implies forking and extending the entire Android Open Source Project. As noble a goal as that might be, doing that across all the major Android versions I want to support (2.2, 2.3, 4.0 and now 4.1) was more work than I felt like taking on (not to mention the question of how to deploy that work). I decided to build something entirely new which did not have this requirement.</p>

<p>Enter Orangutan. Unlike MonkeyRunner, Orangutan simply injects events directly into low-level the kernel device file that represents an Android device&rsquo;s touch screen. It&rsquo;s fast (written in native C), trivial to build, and seems to work seamlessly with any application I&rsquo;ve tried using it with (including Google Chrome for Android). Most interestingly for Mozilla, this interface is also present on Firefox OS (<a href="https://wiki.mozilla.org/B2G">Boot to Gecko</a>) based devices, so we should be able to use Orangutan there to support both Eideticker and any other testing framework which needs to test real-world user input test cases. Exciting times!</p> 
  <hr/>
</article>
<article>
  <header>
    <h2><a href="/blog/2012/06/mobile-firefox-measuring-how-a-browser-feels/">Mobile Firefox: Measuring How a Browser Feels</a></h2>
    <p class="index-date">Jun 26th, 2012</p>
    <p><span class="tags"><a href="/tags/Eideticker.html">Eideticker</a>  <a href="/tags/Mozilla.html">Mozilla</a></span></p>
  </header>

<blockquote>
 <p>A while back, I began work on a new test framework for mobile browsers called Eideticker, which aims to benchmark browsers by capturing them on HMDI video, then running image analysis on the result. I wrote about this in a blog post entitled, “<a href="http://wrla.ch/blog/2011/11/measuring-what-the-user-sees/">Measuring what the user sees</a>.” Some seven months later, we are about to release a new version of Firefox for Android and Eideticker has played a major role in qualifying its performance and identifying areas for improvement along the way.</p></blockquote>

<p>I thought it would be worth publicizing some of the results that we have seen so far and explain why Eideticker has been useful. This post aims to explain the ideas behind Eideticker and hopes to inspire ideas on how to further improve objective cross-browser benchmarks.</p>

<p><strong>Idea 1: Put cross-browser performance tests on a more rigorous footing</strong></p>

<p>One of the problems with existing benchmarks is that the graphical performance that they measure is entirely synthetic. So when something like Microsoft&rsquo;s fishbowl demo claims 50 frames per second, that is based entirely on an internal measurement. There is no guarantee that is what the user is actually seeing. For all we know, it could be throwing half those frames away. To say nothing of the fact that measuring the results could interfere with the results themselves!</p>

<p>With Eideticker, we only analyze what the user sees (under the assumption that what the user sees is what comes out of the device&rsquo;s HDMI out). To measure frame rate, Eideticker painstakingly analyzes a video capture to see the difference between each frame. Only if one frame is qualitatively different than the one before it will it consider it to be a step forward in the animation progression. There is no room for a browser to &ldquo;cheat&rdquo; by, for example, throwing a frame away. Here are two example frames from an Eideticker capture of an animated clock, along with a visual representation of the difference it measured between them:</p>

<table style="border:none;">
 <tr>
  <td></td> 
  <td></td> 
  <td></td></tr></table>

<p>&nbsp;</p>

<p></p>

<p><em>Note: The red area of the graphic on the right indicates a region that Eideticker has detected as having changed between the two images. The black area of the graphic indicates a region that is unchanged.</em></p>

<p>Seeing visual evidence like this increases our confidence that things are truly better than they were before. For example, Eideticker very clearly, and accurately, measured the improvement when <a href="http://benoitgirard.wordpress.com/2012/05/15/off-main-thread-compositing-omtc-and-why-it-matters/">Off Main Thread Compositing</a> landed. We saw a big performance jump in the afore-mentioned clock benchmark:
 <br />
 <br />&nbsp;</p>

<p>&nbsp;
 <br /><em>Note: Nightly = the new Firefox for Android as of that date (an incremental step towards what was just released), XUL = Previous Firefox for Android, Stock = Default browser that comes with Android 2.2.</em></p>

<p><strong>Idea 2: Measure subjective performance based on actual user interaction patterns</strong></p>

<p>Measuring real browser output is useful, but the problem is that these benchmarks do not actually measure how a user experiences the Web. Does an animated image of a clock or a <a href="http://ie.microsoft.com/testdrive/Performance/FishIETank/">fishtank</a> actually represent a normal user experience? Thanks to the development of mobile gaming, this is slowly changing, but I was still say “no.”  The majority of users time spent mobile browsing is spent on news websites, Wikipedia, Facebook and I Can Haz Cheezburger. <a href="#_msocom_1"></a> For these sites, I would submit that there are two things users care about:</p>

<ol>
 <li>
  <p>When I swipe to move the content (e.g. to scroll down to see more content on <a href="http://CNN.com/">CNN.com</a>), does it respond instantaneously and in a pleasing manner? Do I see a nice smooth animation or a jerky mess?</p></li>
 <li>
  <p>When the content moves, do I see new content right away? Or do I have to wait a few moments while the view updates (this slow load is also called checkerboarding)?</p></li></ol>

<p>&nbsp;
 <br />I think the key here is to measure what the user sees. Internal measurements for anything other than what the user experiences are misleading and inconsistent across browsers.</p>

<p>For the first item, I believe the best indication of perceived responsiveness and smoothness is found by measuring the number of frames that are displayed in response to user interaction. As with all measurements, it is not perfect, but one can safely say that if there are only a few frames changed in response to a swipe, the experience is going to be jerky.</p>

<p>Compare these two videos of panning on <a href="http://CNN.com/">CNN.com</a>. The first is the previous Firefox for Android, clocking in at about 12.3 frames per second (fps). The second is the recent Firefox for Android , clocking in at 23 fps using Eideticker&rsquo;s internal measurements:</p>

<p>&nbsp;</p>

<table style="border: none;">
 <tr>
  <td>
   <video width="200px" height="240" src="/files/2012/06/xul-fennec-cnn.webm" controls="controls"></video></td> 
  <td>
   <video width="200px" height="240" src="/files/2012/06/native-fennec-cnn.webm" controls="controls"></video></td></tr></table>

<p>For the second, we can easily measure how quickly a user sees content by setting the background color of the page to an obvious color (in Eideticker we use magenta), overlaying an image on top, then measuring the amount of the page that is magenta while panning around. Since all modern browsers just use the background color of the page when something is to be redrawn (or at least can be configured that way), it&rsquo;s easy to compare across browsers. You can see in the videos above that the new Native Firefox does much better than the old one in this regard, at least on this benchmark. Here&rsquo;s an image of Eideticker detecting checkerboarding on a capture (red indicates checkerboarded areas):</p>

<table style="border:none;">
 <tr>
  <td></td> 
  <td></td></tr></table>

<p></p>

<table style="border: none;">
 <tr>
  <td></td> 
  <td></td></tr></table>

<p><em>Note: The red area of the graphic on the right indicates a region that Eideticker has detected as checkerboarded (i.e. undrawn). The black area of the graphic indicates a region that is fully drawn.</em></p>

<p>The important thing in both cases is that these captures represent <strong>a real user experience</strong>. The swipe gestures are synthesized such that they are interpreted by Android as an actual touch event. This is important: using tricks like <a href="https://developer.mozilla.org/en/DOM/window.scrollTo">javascript scrollTo</a> inside your Web page to pan would not actually engage the renderer in quite the same way. On Firefox for Android (and probably other browsers as well, though I haven&rsquo;t checked), the response to a touch event is always handled inside the browser internal rendering engine to give the expected &ldquo;physical feel.&rdquo; Manually moving the viewport would give completely different results since so much of the fancy code we use to reduce the redraw delay would not be engaged.</p>

<p><strong>Conclusion</strong></p>

<p>Overall, I am very happy with how Eideticker has allowed us to track and measure improvements in Firefox for Android. In developing Eideticker, we aimed to create a benchmark that measured how users actually interact with a browser – not how abstract measurements claim how great a browser is.  As we move ahead with new projects to improve Firefox for Android, Eideticker will continue to be useful in making sure that using our browser is the best experience that it can be, especially combined with other tools like Benoit Girard&rsquo;s <a href="http://benoitgirard.wordpress.com/2012/03/30/writing-a-profiler/">sampling profiler</a>.</p>

<p>For more information on Eideticker, feel free to visit <a href="https://wiki.mozilla.org/Project_Eideticker">its homepage</a> on <a href="http://wiki.mozilla.org/">wiki.mozilla.org</a>.</p>

<p>&nbsp;</p> 
  <hr/>
</article>
<article>
  <header>
    <h2><a href="/blog/2012/06/mass-code-relicensing-with-facebook-s-codemod/">Mass code relicensing with facebook&rsquo;s codemod</a></h2>
    <p class="index-date">Jun 7th, 2012</p>
    <p><span class="tags"><a href="/tags/Mozilla.html">Mozilla</a></span></p>
  </header>

<p>Recently the Firefox source repository (mozilla-central) was converted over recently to a new license with a <a href="http://www.mozilla.org/MPL/headers/">lovely short boilerplate</a>. This is great, but here in <a href="https://wiki.mozilla.org/Auto-tools">automation and tools</a>, we have a fairly large number of projects that live outside of the main tree but for which the new license still applies. A few weeks ago, I wanted to move one our projects over (mozbase), but didn&rsquo;t want to spend hours manually editing text files. I understand that a script was used to convert mozilla-central, but a quick google didn&rsquo;t turn it up. <strong>[ edit:** thanks to Ed Morley for pointing out to me that it lives here: <a href="http://hg.mozilla.org/users/gerv_mozilla.org/relic/">http://hg.mozilla.org/users/gerv_mozilla.org/relic/</a> **]</strong></p>

<p>I surely could have asked about where this script is, but this problem gave me an excuse to try something that I&rsquo;d been meaning to for a while: Facebook&rsquo;s <a href="https://github.com/facebook/codemod">codemod</a>. Codemod is a neat little command-line utility which aims to help with mass refactorings of code. All you have to do is provide a few regular expressions to replace, and off it goes. I tried it out with mozbase, and the results were great: 5 minutes spent coming up with a regular expression and jiggering with command line options, and the job was done.</p>

<p>I had the desire to do this again today for <a href="http://github.com/mozilla/eideticker">Eideticker</a>, and decided to document the (extremely simple) process for posterity. I just used this simple command line&#8230;</p>

<p><code>../codemod/src/codemod.py --extensions py -m '# \*\*\*\*\* BEGIN LICENSE.*END LICENSE BLOCK \*\*\*\*\*' '# This Source Code Form is subject to the terms of the Mozilla Public\n# License, v. 2.0. If a copy of the MPL was not distributed with this file,\n# You can obtain one at http://mozilla.org/MPL/2.0/.'</code></p>

<p>&#8230; et voila, out popped <a href="https://github.com/mozilla/eideticker/commit/9456933670fb4590af3060f4ff40d11271859b8d">shiny new boilerplate</a>.</p> 
  <hr/>
</article>
<article>
  <header>
    <h2><a href="/blog/2012/05/ghetto-retroscope-with-ffmpeg-and-the-lt-video-gt-tag/">Ghetto retroscope with ffmpeg and the &lt;video&gt; tag</a></h2>
    <p class="index-date">May 7th, 2012</p>
    <p><span class="tags"><a href="/tags/Mozilla.html">Mozilla</a>  <a href="/tags/Video.html">Video</a></span></p>
  </header>

<p>So yesterday we had a small get-together at my place, which gave me the opportunity to try something I&rsquo;d been meaning to do for a while: build my own retroscope.</p>

<p>The idea is pretty simple: have a webcam record bits and pieces of a social event, then play them back on-the-spot a few minutes/hours later. I first heard about the concept from reading Nat Friedman&rsquo;s <a href="http://nat.org/blog/2005/10/the-retroscope/">blog entry</a> from 2005 &#8212; if you read that, you see that he just hooked up a video camera to his TiVo. 7 years in the future, laptop webcams are ubiquitous and we have the awesome HTML5  tag, so I figured it would be easy to knock up something interesting in short order with zero custom hardware.</p>

<p>Having only remembered that I wanted to do this about 30 minutes before people were scheduled to start arriving, I didn&rsquo;t have much time to do anything really perfect. I settled on using <a href="http://stackoverflow.com/questions/7500763/command-line-streaming-webcam-with-audio-from-ubuntu-server-in-webm-format">this little snippet</a> from stackoverflow to generate short (5 second) movies on my laptop, then used scp to copy them over and display a montage of them in an auto-refreshing webpage on my &ldquo;television&rdquo; (which is a Mac-Mini connected to a large computer monitor). Despite being a total hack job, the end result generated much amusement. I think this is a bit different from what Nat originally did (it sounds from his blog like his retroscope played back longer segments), but I think the end result is actually a bit more fun.</p>

<p><a href="http://wrla.ch/blog/2012/05/ghetto-retroscope-with-ffmpeg-and-the-video-tag/retroscope-screenshot/" rel="attachment wp-att-598"><img src="/files/2012/05/retroscope-screenshot-1024x694.png" alt="" title="retroscope-screenshot" width="640" height="433" class="alignnone size-large wp-image-598" srcset="/files/2012/05/retroscope-screenshot-300x203.png 300w, /files/2012/05/retroscope-screenshot-1024x694.png 1024w, /files/2012/05/retroscope-screenshot.png 1319w" sizes="(max-width: 640px) 100vw, 640px" /></a></p>

<p>Perhaps unfortunately, but probably ultimately for the best, only a few snippets from the actual night got stored away. One example is this gem:</p>

<p>(yes, that handsome fellow with the Pernot is me)</p>

<p>I thought it might be fun to release the slightly-cleaned up results of this experiment as opensource for others to play with, so I created a small project for it on github. Unlike the original version, no complicated scp scheme is required &#8212; I just reused Joel Maher&rsquo;s most excellent mozhttpd library from <a href="http://github.com/mozilla/mozbase">mozbase</a> to run a web server in the same process as the capture logic. All you need to do is run the server on a Linux machine with a webcam and connect to it with a web browser from any other machine on your local network.</p>

<p><a href="https://github.com/wlach/retroscope">https://github.com/wlach/retroscope</a></p>

<p>Enjoy!</p> 
  <hr/>
</article>
<article>
  <header>
    <h2><a href="/blog/2012/05/launching-random-web-browsers-on-android/">Launching random web browsers on Android</a></h2>
    <p class="index-date">May 4th, 2012</p>
    <p><span class="tags"><a href="/tags/Android.html">Android</a>  <a href="/tags/Mozilla.html">Mozilla</a></span></p>
  </header>

<p>Ok, this is somewhat mundane, but I&rsquo;ve already had to do it twice (and helped someone do something similar on #mobile), so I figured I might as well blog about it for posterity.</p>

<p>For various automation tasks (notably the <a href="http://wrla.ch/eideticker/dashboard/">Eideticker dashboard</a> and the <a href="http://mrcote.info/phonedash/#/rawfennecstartup">cross-browser startup tests</a>), we need to be able to launch an Android browser on the command line (via adb shell or our own custom SUTAgent). This is a bit of a black art, but you can find references on how to do this on stackoverflow and other places. The magic incantation is:</p>

<pre><code>am start -a android.intent.action.VIEW -n &amp;lt;application/intent&amp;gt; -d &amp;lt;url&amp;gt;</code></pre>

<p>So, for example, to launch Fennec, you&rsquo;d run this on the Android command prompt:</p>

<pre><code>am start -a android.intent.action.VIEW -n org.mozilla.fennec/.App -d http://mygreatsite.info</code></pre>

<p>Ok, easy enough, but what if we want to launch a new browser that we just downloaded (e.g. Google Chrome)? Where do we get the application and intent names?</p>

<p>The short answer is that you need to reach into the apk and dig. 😉 There&rsquo;s probably many ways of doing this, but here&rsquo;s what I do (which has the distinct advantage of not needing to compile, download or run weird java applications):</p>

<ol>
 <li>
  <p>Copy the apk onto your machine (the apk should be in /data/app: if you have a rooted phone, you should be able to copy that off to your machine).</p></li>
 <li>
  <p>Extract <em>AndroidManifest.xml</em> from the apk (it&rsquo;s just a .zip) and run <a href="http://android-random.googlecode.com/svn/trunk/axml2xml/axml2xml.pl">axml2xml.pl</a> on it.</p></li>
 <li>
  <p>Examine the resultant xml file and look for the <strong></strong> tag. It should have a property called <strong></strong> which is the package name. For example:</p></li></ol>

<p>We can see pretty clearly that the application name in this case is <strong>com.android.chrome</strong> (you can also get this by running ps when using the application)</p>

<ol>
 <li>Finally, look for a tag called <strong></strong> with an <strong></strong> tag with <strong></strong> as the <strong>android-name</strong> property. Scan up for the overarching <strong>activity</strong> tag, whose <strong>android-name</strong> property. This is the activity name. For example:</li></ol>

<p>Likewise here we see that the activity name we want is <strong>.Main</strong> (which Android explicitly expands out to <strong>com.android.chrome.Main</strong>)</p>

<p>Armed with this information, you should now have enough information to launch the application. Furthering the example above, here&rsquo;s how to start Chrome on Android via adb&rsquo;s shell:</p>

<pre><code>am start -a android.intent.action.VIEW -n com.android.chrome/.Main -d http://mygreatsite.info</code></pre>

<p>Hope this helps someone, somewhere.</p> 
  <hr/>
</article>
<footer>
 <ul class="pagination">
  <li class="page-item"><a class="page-link" href="/index-11.html">
    <quote>&larr;</quote></a></li>
  <li class="page-item"><a class="page-link" href="/index.html">1</a></li>
  <li class="page-item"><a class="page-link" href="/index-2.html">2</a></li>
  <li class="page-item"><a class="page-link" href="/index-3.html">3</a></li>
  <li class="page-item"><a class="page-link" href="/index-4.html">4</a></li>
  <li class="page-item"><a class="page-link" href="/index-5.html">5</a></li>
  <li class="page-item"><a class="page-link" href="/index-6.html">6</a></li>
  <li class="page-item"><a class="page-link" href="/index-7.html">7</a></li>
  <li class="page-item"><a class="page-link" href="/index-8.html">8</a></li>
  <li class="page-item"><a class="page-link" href="/index-9.html">9</a></li>
  <li class="page-item"><a class="page-link" href="/index-10.html">10</a></li>
  <li class="page-item"><a class="page-link" href="/index-11.html">11</a></li>
  <li class="page-item active"><a class="page-link" href="/index-12.html">12</a></li>
  <li class="page-item"><a class="page-link" href="/index-13.html">13</a></li>
  <li class="page-item"><a class="page-link" href="/index-14.html">14</a></li>
  <li class="page-item"><a class="page-link" href="/index-15.html">15</a></li>
  <li class="page-item"><a class="page-link" href="/index-16.html">16</a></li>
  <li class="page-item"><a class="page-link" href="/index-17.html">17</a></li>
  <li class="page-item"><a class="page-link" href="/index-13.html">
    <quote>&rarr;</quote></a></li></ul></footer>
    </div>
    <footer class="container max-w-screen-md px-8 py-4 mx-auto less-important">
      <p>Comments / thoughts? Feel free to send an email to wlach on protonmail.com,
        or toot <a rel="me" href="https://mastodon.social/@wlach">@wlach@mastodon.social</a>.
      </p>
      <p>
        Site generated by
        <a href="https://github.com/greghendershott/frog">Frog</a>.
        Post content is licensed under a
        <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"
          >Creative Commons Attribution 4.0 Unported License</a
        >.
      </p>
    </footer>
  </body>
</html>